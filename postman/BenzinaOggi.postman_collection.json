{
  "info": {
    "_postman_id": "3a2d3f2e-9b5a-4f3a-9f2a-3f9a2b5c7d8e",
    "name": "BenzinaOggi API (Core Plugin)",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "description": "Solo le API usate dal plugin WordPress: lista/ dettaglio distributori, aggiornamenti prezzi (CSV), forzatura singolo impianto, notifiche variazioni, subscriptions."
  },
  "item": [
    {
      "name": "Distributors (list)",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/distributors?city={{city}}&fuel={{fuel}}&brand={{brand}}&sort={{sort}}&lat={{lat}}&lon={{lon}}&limit={{limit}}",
          "host": ["{{baseUrl}}"],
          "path": ["api","distributors"],
          "query": [
            { "key": "city", "value": "{{city}}" },
            { "key": "fuel", "value": "{{fuel}}" },
            { "key": "brand", "value": "{{brand}}" },
            { "key": "sort", "value": "{{sort}}" },
            { "key": "lat", "value": "{{lat}}" },
            { "key": "lon", "value": "{{lon}}" },
            { "key": "limit", "value": "{{limit}}" }
          ]
        }
      },
      "description": "Endpoint principale usato dal plugin per la ricerca con filtri/paginazione."
    },
    {
      "name": "Distributor (detail)",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/distributor/{{impiantoId}}",
          "host": ["{{baseUrl}}"],
          "path": ["api","distributor","{{impiantoId}}"]
        }
      },
      "description": "Dettaglio distributore per pagina WordPress."
    },
    {
      "name": "Cron: Update prices (CSV)",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/cron/update-prices-daily?debug=false",
          "host": ["{{baseUrl}}"],
          "path": ["api","cron","update-prices-daily"],
          "query": [ { "key": "debug", "value": "false" } ]
        }
      },
      "description": "Cron giornaliero (Vercel) per aggiornare prezzi dal CSV MIMIT e inviare notifiche immediate."
    },
    {
      "name": "Force update distributor (CSVâ†’fallback MISE)",
      "request": {
        "method": "POST",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/force-update-distributor?impiantoId={{impiantoId}}&force=true&debug=true",
          "host": ["{{baseUrl}}"],
          "path": ["api","force-update-distributor"],
          "query": [
            { "key": "impiantoId", "value": "{{impiantoId}}" },
            { "key": "force", "value": "true" },
            { "key": "debug", "value": "true" }
          ]
        }
      },
      "description": "Aggiorna un singolo impianto. Usa CSV come fonte primaria; MISE solo se il CSV non ha righe."
    },
    {
      "name": "Notify variations (today, downs created today)",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/cron/notify-variations",
          "host": ["{{baseUrl}}"],
          "path": ["api","cron","notify-variations"]
        }
      },
      "description": "Invia notifiche per tutti i ribassi con PriceVariation.createdAt di oggi (UTC)."
    },
    {
      "name": "Notify variations (by createdDay, downs)",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/cron/notify-variations?createdDay=YYYY-MM-DD",
          "host": ["{{baseUrl}}"],
          "path": ["api","cron","notify-variations"],
          "query": [
            { "key": "createdDay", "value": "YYYY-MM-DD" }
          ]
        }
      },
      "description": "Invia notifiche solo per i ribassi creati nel giorno indicato (UTC)."
    },
    {
      "name": "Subscriptions: create/update",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" } ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"externalId\": \"user-123\",\n  \"impiantoId\": {{impiantoId}},\n  \"fuelType\": \"{{fuelType}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/subscriptions",
          "host": ["{{baseUrl}}"],
          "path": ["api","subscriptions"]
        }
      },
      "description": "Crea/aggiorna una subscription (externalId + impianto + fuel)."
    },
    {
      "name": "Subscriptions: list externalIds",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/subscriptions?impiantoId={{impiantoId}}&fuelType={{fuelType}}",
          "host": ["{{baseUrl}}"],
          "path": ["api","subscriptions"],
          "query": [
            { "key": "impiantoId", "value": "{{impiantoId}}" },
            { "key": "fuelType", "value": "{{fuelType}}" }
          ]
        }
      },
      "description": "Ritorna gli externalId iscritti a (impiantoId, fuelType)."
    },
    {
      "name": "Cleanup PriceVariation (GET - check)",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{apiSecret}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/cleanup-price-variations?date={{cleanupDate}}",
          "host": ["{{baseUrl}}"],
          "path": ["api","cleanup-price-variations"],
          "query": [
            { "key": "date", "value": "{{cleanupDate}}" }
          ]
        }
      },
      "description": "Controlla quanti record PriceVariation esistono per una data specifica (default: ieri). Non elimina nulla."
    },
    {
      "name": "Cleanup PriceVariation (POST - delete)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{apiSecret}}"
          },
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"date\": \"{{cleanupDate}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/cleanup-price-variations",
          "host": ["{{baseUrl}}"],
          "path": ["api","cleanup-price-variations"]
        }
      },
      "description": "Elimina tutti i record PriceVariation per una data specifica (default: ieri). Richiede Bearer token."
    },
    {
      "name": "Telegram: Setup Webhook",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"action\": \"set\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/telegram/setup",
          "host": ["{{baseUrl}}"],
          "path": ["api","telegram","setup"]
        }
      },
      "description": "Configura il webhook Telegram per ricevere messaggi dal bot. Usa action: 'set' per configurare, 'delete' per rimuovere."
    },
    {
      "name": "Telegram: Get Bot Info",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/telegram/setup",
          "host": ["{{baseUrl}}"],
          "path": ["api","telegram","setup"]
        }
      },
      "description": "Ottieni informazioni sul bot Telegram e status del webhook."
    },
    {
      "name": "Telegram: Send Notifications",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{apiSecret}}"
          },
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"type\": \"price_drop\",\n  \"data\": {\n    \"notifications\": [\n      {\n        \"distributorId\": 123,\n        \"impiantoId\": 8284,\n        \"distributor\": {\n          \"bandiera\": \"Test Station\",\n          \"comune\": \"Roma\",\n          \"indirizzo\": \"Via Test 123\"\n        },\n        \"fuelType\": \"Benzina\",\n        \"baseFuelType\": \"Benzina\",\n        \"isSelfService\": false,\n        \"oldPrice\": 1.650,\n        \"newPrice\": 1.640,\n        \"direction\": \"down\",\n        \"delta\": -0.010,\n        \"percentage\": -0.6\n      }\n    ]\n  }\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/telegram/notify",
          "host": ["{{baseUrl}}"],
          "path": ["api","telegram","notify"]
        }
      },
      "description": "Invia notifiche di ribassi prezzi agli utenti Telegram iscritti. Richiede Bearer token."
    },
    {
      "name": "Telegram: Get Stats",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/api/telegram/notify",
          "host": ["{{baseUrl}}"],
          "path": ["api","telegram","notify"]
        }
      },
      "description": "Ottieni statistiche sugli utenti Telegram attivi e iscrizioni."
    }
  ],
  "event": [],
  "variable": [
    { "key": "baseUrl", "value": "http://localhost:3000" },
    { "key": "city", "value": "" },
    { "key": "fuel", "value": "" },
    { "key": "brand", "value": "" },
    { "key": "sort", "value": "" },
    { "key": "lat", "value": "" },
    { "key": "lon", "value": "" },
    { "key": "limit", "value": "200" },
    { "key": "impiantoId", "value": "59183" },
    { "key": "fuelType", "value": "Benzina" },
    { "key": "apiSecret", "value": "your-api-secret-token" },
    { "key": "cleanupDate", "value": "2025-10-01" }
  ]
}

